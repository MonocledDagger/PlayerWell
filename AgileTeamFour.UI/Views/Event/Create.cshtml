@model AgileTeamFour.UI.ViewModels.EventVM

@{
    ViewData["Title"] = "Create";
}

<h1>Create</h1>

<h4>Events</h4>
<hr />
<div class="row">
    <div class="col-md-4">
        <form asp-action="Create" asp-controller="Event" method="post">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>

            <!-- Dynamic GameID Input -->
            <div class="form-group">
                <label asp-for="Event.GameID" class="control-label"></label>
                <input type="text" id="gameSearch" class="form-control" placeholder="Search for a game..." />
                <input type="hidden" id="selectedGameId" name="Event.GameID" />
                <div id="gameDropdown" class="dropdown-menu" style="display:none;"></div>
                <span asp-validation-for="Event.GameID" class="text-danger"></span>
            </div>
            <!-- End Dynamic GameID Input -->

            <div class="form-group">
                <label asp-for="Event.EventName" class="control-label"></label>
                <input asp-for="Event.EventName" class="form-control" />
                <span asp-validation-for="Event.EventName" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.Server" class="control-label"></label>
                <input asp-for="Event.Server" class="form-control" />
                <span asp-validation-for="Event.Server" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.MaxPlayers" class="control-label"></label>
                <input asp-for="Event.MaxPlayers" class="form-control" type="number" min="1" />
                <span asp-validation-for="Event.MaxPlayers" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.Type" class="control-label"></label>
                <input asp-for="Event.Type" class="form-control" />
                <span asp-validation-for="Event.Type" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.Platform" class="control-label"></label>
                <input asp-for="Event.Platform" class="form-control" />
                <span asp-validation-for="Event.Platform" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.Description" class="control-label"></label>
                <input asp-for="Event.Description" class="form-control" />
                <span asp-validation-for="Event.Description" class="text-danger"></span>
            </div>
            <div class="form-group">
                <label asp-for="Event.DateTime" class="control-label"></label>
                <input asp-for="Event.DateTime" class="form-control" />
                <span asp-validation-for="Event.DateTime" class="text-danger"></span>
            </div>
            <div class="form-group">
                <input type="submit" value="Create" class="btn btn-primary" />
            </div>
        </form>
    </div>
</div>

<div>
    <a asp-action="Index">Back to List</a>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script>
        $(document).ready(function () {
            var $input = $('#gameSearch');
            var $dropdown = $('#gameDropdown');
            var $hiddenInput = $('#selectedGameId');

            // RAWG API key
            var apiKey = '478858b62b2042d8a325a06eb9067767';

            // Event handler for when the user types in the input field
            $input.on('input', function () {
                var query = $input.val();

                // Only trigger search if the input has 3 or more characters
                if (query.length >= 3) {
                    $.ajax({
                        url: `https://api.rawg.io/api/games?key=${apiKey}&search=${encodeURIComponent(query)}`,
                        type: 'GET',
                        success: function (data) {
                            $dropdown.empty(); // Clear previous results
                            if (data.results.length > 0) {
                                $dropdown.show();
                                data.results.forEach(function (game) {
                                    var gameOption = $('<a/>', {
                                        'class': 'dropdown-item',
                                        'text': game.name, // Display game name
                                        'href': '#',
                                        'click': function () {
                                            $input.val(game.name); // Fill the input with the selected game name
                                            $hiddenInput.val(game.id); // Set the hidden input with the selected game ID
                                            $dropdown.hide(); // Hide the dropdown
                                            return false;
                                        }
                                    });
                                    $dropdown.append(gameOption);
                                });
                            } else {
                                $dropdown.hide();
                            }
                        },
                        error: function () {
                            $dropdown.hide();
                        }
                    });
                } else {
                    $dropdown.hide(); // Hide dropdown if less than 3 characters
                }
            });

            // Hide the dropdown if the user clicks outside
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#gameSearch, #gameDropdown').length) {
                    $dropdown.hide();
                }
            });
        });
    </script>
}
